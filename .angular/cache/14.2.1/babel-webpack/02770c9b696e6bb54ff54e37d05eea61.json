{"ast":null,"code":"import inherits from 'inherits-browser';\nimport CommandInterceptor from 'diagram-js/lib/command/CommandInterceptor';\nimport { getBusinessObject, getDi, is } from '../../../util/ModelUtil';\nimport { isAny } from '../util/ModelingUtil';\nimport UpdateSemanticParentHandler from '../cmd/UpdateSemanticParentHandler';\n/**\r\n * BPMN specific data store behavior\r\n */\n\nexport default function DataStoreBehavior(canvas, commandStack, elementRegistry, eventBus) {\n  CommandInterceptor.call(this, eventBus);\n  commandStack.registerHandler('dataStore.updateContainment', UpdateSemanticParentHandler);\n\n  function getFirstParticipantWithProcessRef() {\n    return elementRegistry.filter(function (element) {\n      return is(element, 'bpmn:Participant') && getBusinessObject(element).processRef;\n    })[0];\n  }\n\n  function getDataStores(element) {\n    return element.children.filter(function (child) {\n      return is(child, 'bpmn:DataStoreReference') && !child.labelTarget;\n    });\n  }\n\n  function updateDataStoreParent(dataStore, newDataStoreParent) {\n    var dataStoreBo = dataStore.businessObject || dataStore;\n    newDataStoreParent = newDataStoreParent || getFirstParticipantWithProcessRef();\n\n    if (newDataStoreParent) {\n      var newDataStoreParentBo = newDataStoreParent.businessObject || newDataStoreParent;\n      commandStack.execute('dataStore.updateContainment', {\n        dataStoreBo: dataStoreBo,\n        dataStoreDi: getDi(dataStore),\n        newSemanticParent: newDataStoreParentBo.processRef || newDataStoreParentBo,\n        newDiParent: getDi(newDataStoreParent)\n      });\n    }\n  } // disable auto-resize for data stores\n\n\n  this.preExecute('shape.create', function (event) {\n    var context = event.context,\n        shape = context.shape;\n\n    if (is(shape, 'bpmn:DataStoreReference') && shape.type !== 'label') {\n      if (!context.hints) {\n        context.hints = {};\n      } // prevent auto resizing\n\n\n      context.hints.autoResize = false;\n    }\n  }); // disable auto-resize for data stores\n\n  this.preExecute('elements.move', function (event) {\n    var context = event.context,\n        shapes = context.shapes;\n    var dataStoreReferences = shapes.filter(function (shape) {\n      return is(shape, 'bpmn:DataStoreReference');\n    });\n\n    if (dataStoreReferences.length) {\n      if (!context.hints) {\n        context.hints = {};\n      } // prevent auto resizing for data store references\n\n\n      context.hints.autoResize = shapes.filter(function (shape) {\n        return !is(shape, 'bpmn:DataStoreReference');\n      });\n    }\n  }); // update parent on data store created\n\n  this.postExecute('shape.create', function (event) {\n    var context = event.context,\n        shape = context.shape,\n        parent = shape.parent;\n\n    if (is(shape, 'bpmn:DataStoreReference') && shape.type !== 'label' && is(parent, 'bpmn:Collaboration')) {\n      updateDataStoreParent(shape);\n    }\n  }); // update parent on data store moved\n\n  this.postExecute('shape.move', function (event) {\n    var context = event.context,\n        shape = context.shape,\n        oldParent = context.oldParent,\n        parent = shape.parent;\n\n    if (is(oldParent, 'bpmn:Collaboration')) {\n      // do nothing if not necessary\n      return;\n    }\n\n    if (is(shape, 'bpmn:DataStoreReference') && shape.type !== 'label' && is(parent, 'bpmn:Collaboration')) {\n      var participant = is(oldParent, 'bpmn:Participant') ? oldParent : getAncestor(oldParent, 'bpmn:Participant');\n      updateDataStoreParent(shape, participant);\n    }\n  }); // update data store parents on participant or subprocess deleted\n\n  this.postExecute('shape.delete', function (event) {\n    var context = event.context,\n        shape = context.shape,\n        rootElement = canvas.getRootElement();\n\n    if (isAny(shape, ['bpmn:Participant', 'bpmn:SubProcess']) && is(rootElement, 'bpmn:Collaboration')) {\n      getDataStores(rootElement).filter(function (dataStore) {\n        return isDescendant(dataStore, shape);\n      }).forEach(function (dataStore) {\n        updateDataStoreParent(dataStore);\n      });\n    }\n  }); // update data store parents on collaboration -> process\n\n  this.postExecute('canvas.updateRoot', function (event) {\n    var context = event.context,\n        oldRoot = context.oldRoot,\n        newRoot = context.newRoot;\n    var dataStores = getDataStores(oldRoot);\n    dataStores.forEach(function (dataStore) {\n      if (is(newRoot, 'bpmn:Process')) {\n        updateDataStoreParent(dataStore, newRoot);\n      }\n    });\n  });\n}\nDataStoreBehavior.$inject = ['canvas', 'commandStack', 'elementRegistry', 'eventBus'];\ninherits(DataStoreBehavior, CommandInterceptor); // helpers //////////\n\nfunction isDescendant(descendant, ancestor) {\n  var descendantBo = descendant.businessObject || descendant,\n      ancestorBo = ancestor.businessObject || ancestor;\n\n  while (descendantBo.$parent) {\n    if (descendantBo.$parent === ancestorBo.processRef || ancestorBo) {\n      return true;\n    }\n\n    descendantBo = descendantBo.$parent;\n  }\n\n  return false;\n}\n\nfunction getAncestor(element, type) {\n  while (element.parent) {\n    if (is(element.parent, type)) {\n      return element.parent;\n    }\n\n    element = element.parent;\n  }\n}","map":{"version":3,"names":["inherits","CommandInterceptor","getBusinessObject","getDi","is","isAny","UpdateSemanticParentHandler","DataStoreBehavior","canvas","commandStack","elementRegistry","eventBus","call","registerHandler","getFirstParticipantWithProcessRef","filter","element","processRef","getDataStores","children","child","labelTarget","updateDataStoreParent","dataStore","newDataStoreParent","dataStoreBo","businessObject","newDataStoreParentBo","execute","dataStoreDi","newSemanticParent","newDiParent","preExecute","event","context","shape","type","hints","autoResize","shapes","dataStoreReferences","length","postExecute","parent","oldParent","participant","getAncestor","rootElement","getRootElement","isDescendant","forEach","oldRoot","newRoot","dataStores","$inject","descendant","ancestor","descendantBo","ancestorBo","$parent"],"sources":["E:/Old_PC/Study/Angular/test-bpm/node_modules/bpmn-js/lib/features/modeling/behavior/DataStoreBehavior.js"],"sourcesContent":["import inherits from 'inherits-browser';\r\n\r\nimport CommandInterceptor from 'diagram-js/lib/command/CommandInterceptor';\r\n\r\nimport {\r\n  getBusinessObject,\r\n  getDi,\r\n  is\r\n} from '../../../util/ModelUtil';\r\n\r\nimport { isAny } from '../util/ModelingUtil';\r\n\r\nimport UpdateSemanticParentHandler from '../cmd/UpdateSemanticParentHandler';\r\n\r\n\r\n/**\r\n * BPMN specific data store behavior\r\n */\r\nexport default function DataStoreBehavior(\r\n    canvas, commandStack, elementRegistry,\r\n    eventBus) {\r\n\r\n  CommandInterceptor.call(this, eventBus);\r\n\r\n  commandStack.registerHandler('dataStore.updateContainment', UpdateSemanticParentHandler);\r\n\r\n  function getFirstParticipantWithProcessRef() {\r\n    return elementRegistry.filter(function(element) {\r\n      return is(element, 'bpmn:Participant') && getBusinessObject(element).processRef;\r\n    })[0];\r\n  }\r\n\r\n  function getDataStores(element) {\r\n    return element.children.filter(function(child) {\r\n      return is(child, 'bpmn:DataStoreReference') && !child.labelTarget;\r\n    });\r\n  }\r\n\r\n  function updateDataStoreParent(dataStore, newDataStoreParent) {\r\n    var dataStoreBo = dataStore.businessObject || dataStore;\r\n\r\n    newDataStoreParent = newDataStoreParent || getFirstParticipantWithProcessRef();\r\n\r\n    if (newDataStoreParent) {\r\n      var newDataStoreParentBo = newDataStoreParent.businessObject || newDataStoreParent;\r\n\r\n      commandStack.execute('dataStore.updateContainment', {\r\n        dataStoreBo: dataStoreBo,\r\n        dataStoreDi: getDi(dataStore),\r\n        newSemanticParent: newDataStoreParentBo.processRef || newDataStoreParentBo,\r\n        newDiParent: getDi(newDataStoreParent)\r\n      });\r\n    }\r\n  }\r\n\r\n\r\n  // disable auto-resize for data stores\r\n  this.preExecute('shape.create', function(event) {\r\n\r\n    var context = event.context,\r\n        shape = context.shape;\r\n\r\n    if (is(shape, 'bpmn:DataStoreReference') &&\r\n        shape.type !== 'label') {\r\n\r\n      if (!context.hints) {\r\n        context.hints = {};\r\n      }\r\n\r\n      // prevent auto resizing\r\n      context.hints.autoResize = false;\r\n    }\r\n  });\r\n\r\n\r\n  // disable auto-resize for data stores\r\n  this.preExecute('elements.move', function(event) {\r\n    var context = event.context,\r\n        shapes = context.shapes;\r\n\r\n    var dataStoreReferences = shapes.filter(function(shape) {\r\n      return is(shape, 'bpmn:DataStoreReference');\r\n    });\r\n\r\n    if (dataStoreReferences.length) {\r\n      if (!context.hints) {\r\n        context.hints = {};\r\n      }\r\n\r\n      // prevent auto resizing for data store references\r\n      context.hints.autoResize = shapes.filter(function(shape) {\r\n        return !is(shape, 'bpmn:DataStoreReference');\r\n      });\r\n    }\r\n  });\r\n\r\n\r\n  // update parent on data store created\r\n  this.postExecute('shape.create', function(event) {\r\n    var context = event.context,\r\n        shape = context.shape,\r\n        parent = shape.parent;\r\n\r\n\r\n    if (is(shape, 'bpmn:DataStoreReference') &&\r\n        shape.type !== 'label' &&\r\n        is(parent, 'bpmn:Collaboration')) {\r\n\r\n      updateDataStoreParent(shape);\r\n    }\r\n  });\r\n\r\n\r\n  // update parent on data store moved\r\n  this.postExecute('shape.move', function(event) {\r\n    var context = event.context,\r\n        shape = context.shape,\r\n        oldParent = context.oldParent,\r\n        parent = shape.parent;\r\n\r\n    if (is(oldParent, 'bpmn:Collaboration')) {\r\n\r\n      // do nothing if not necessary\r\n      return;\r\n    }\r\n\r\n    if (is(shape, 'bpmn:DataStoreReference') &&\r\n        shape.type !== 'label' &&\r\n        is(parent, 'bpmn:Collaboration')) {\r\n\r\n      var participant = is(oldParent, 'bpmn:Participant') ?\r\n        oldParent :\r\n        getAncestor(oldParent, 'bpmn:Participant');\r\n\r\n      updateDataStoreParent(shape, participant);\r\n    }\r\n  });\r\n\r\n\r\n  // update data store parents on participant or subprocess deleted\r\n  this.postExecute('shape.delete', function(event) {\r\n    var context = event.context,\r\n        shape = context.shape,\r\n        rootElement = canvas.getRootElement();\r\n\r\n    if (isAny(shape, [ 'bpmn:Participant', 'bpmn:SubProcess' ])\r\n        && is(rootElement, 'bpmn:Collaboration')) {\r\n      getDataStores(rootElement)\r\n        .filter(function(dataStore) {\r\n          return isDescendant(dataStore, shape);\r\n        })\r\n        .forEach(function(dataStore) {\r\n          updateDataStoreParent(dataStore);\r\n        });\r\n    }\r\n  });\r\n\r\n  // update data store parents on collaboration -> process\r\n  this.postExecute('canvas.updateRoot', function(event) {\r\n    var context = event.context,\r\n        oldRoot = context.oldRoot,\r\n        newRoot = context.newRoot;\r\n\r\n    var dataStores = getDataStores(oldRoot);\r\n\r\n    dataStores.forEach(function(dataStore) {\r\n\r\n      if (is(newRoot, 'bpmn:Process')) {\r\n        updateDataStoreParent(dataStore, newRoot);\r\n      }\r\n\r\n    });\r\n  });\r\n}\r\n\r\nDataStoreBehavior.$inject = [\r\n  'canvas',\r\n  'commandStack',\r\n  'elementRegistry',\r\n  'eventBus',\r\n];\r\n\r\ninherits(DataStoreBehavior, CommandInterceptor);\r\n\r\n\r\n// helpers //////////\r\n\r\nfunction isDescendant(descendant, ancestor) {\r\n  var descendantBo = descendant.businessObject || descendant,\r\n      ancestorBo = ancestor.businessObject || ancestor;\r\n\r\n  while (descendantBo.$parent) {\r\n    if (descendantBo.$parent === ancestorBo.processRef || ancestorBo) {\r\n      return true;\r\n    }\r\n\r\n    descendantBo = descendantBo.$parent;\r\n  }\r\n\r\n  return false;\r\n}\r\n\r\nfunction getAncestor(element, type) {\r\n\r\n  while (element.parent) {\r\n    if (is(element.parent, type)) {\r\n      return element.parent;\r\n    }\r\n\r\n    element = element.parent;\r\n  }\r\n}"],"mappings":"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"},"metadata":{},"sourceType":"module"}