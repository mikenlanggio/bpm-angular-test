{"ast":null,"code":"import inherits from 'inherits-browser';\nimport { find, isArray, matchPattern, some } from 'min-dash';\nimport CommandInterceptor from 'diagram-js/lib/command/CommandInterceptor';\nimport { add as collectionAdd, remove as collectionRemove } from 'diagram-js/lib/util/Collections';\nimport { getBusinessObject, is } from '../../../util/ModelUtil';\nimport { isAny } from '../util/ModelingUtil';\nimport { hasEventDefinition } from '../../../util/DiUtil';\nvar LOW_PRIORITY = 500;\n/**\r\n * Add referenced root elements (error, escalation, message, signal) if they don't exist.\r\n * Copy referenced root elements on copy & paste.\r\n */\n\nexport default function RootElementReferenceBehavior(bpmnjs, eventBus, injector, moddleCopy, bpmnFactory) {\n  injector.invoke(CommandInterceptor, this);\n\n  function canHaveRootElementReference(element) {\n    return isAny(element, ['bpmn:ReceiveTask', 'bpmn:SendTask']) || hasAnyEventDefinition(element, ['bpmn:ErrorEventDefinition', 'bpmn:EscalationEventDefinition', 'bpmn:MessageEventDefinition', 'bpmn:SignalEventDefinition']);\n  }\n\n  function hasRootElement(rootElement) {\n    var definitions = bpmnjs.getDefinitions(),\n        rootElements = definitions.get('rootElements');\n    return !!find(rootElements, matchPattern({\n      id: rootElement.id\n    }));\n  }\n\n  function getRootElementReferencePropertyName(eventDefinition) {\n    if (is(eventDefinition, 'bpmn:ErrorEventDefinition')) {\n      return 'errorRef';\n    } else if (is(eventDefinition, 'bpmn:EscalationEventDefinition')) {\n      return 'escalationRef';\n    } else if (is(eventDefinition, 'bpmn:MessageEventDefinition')) {\n      return 'messageRef';\n    } else if (is(eventDefinition, 'bpmn:SignalEventDefinition')) {\n      return 'signalRef';\n    }\n  }\n\n  function getRootElement(businessObject) {\n    if (isAny(businessObject, ['bpmn:ReceiveTask', 'bpmn:SendTask'])) {\n      return businessObject.get('messageRef');\n    }\n\n    var eventDefinitions = businessObject.get('eventDefinitions'),\n        eventDefinition = eventDefinitions[0];\n    return eventDefinition.get(getRootElementReferencePropertyName(eventDefinition));\n  }\n\n  function setRootElement(businessObject, rootElement) {\n    if (isAny(businessObject, ['bpmn:ReceiveTask', 'bpmn:SendTask'])) {\n      return businessObject.set('messageRef', rootElement);\n    }\n\n    var eventDefinitions = businessObject.get('eventDefinitions'),\n        eventDefinition = eventDefinitions[0];\n    return eventDefinition.set(getRootElementReferencePropertyName(eventDefinition), rootElement);\n  } // create shape\n\n\n  this.executed('shape.create', function (context) {\n    var shape = context.shape;\n\n    if (!canHaveRootElementReference(shape)) {\n      return;\n    }\n\n    var businessObject = getBusinessObject(shape),\n        rootElement = getRootElement(businessObject),\n        rootElements;\n\n    if (rootElement && !hasRootElement(rootElement)) {\n      rootElements = bpmnjs.getDefinitions().get('rootElements'); // add root element\n\n      collectionAdd(rootElements, rootElement);\n      context.addedRootElement = rootElement;\n    }\n  }, true);\n  this.reverted('shape.create', function (context) {\n    var addedRootElement = context.addedRootElement;\n\n    if (!addedRootElement) {\n      return;\n    }\n\n    var rootElements = bpmnjs.getDefinitions().get('rootElements'); // remove root element\n\n    collectionRemove(rootElements, addedRootElement);\n  }, true);\n  eventBus.on('copyPaste.copyElement', function (context) {\n    var descriptor = context.descriptor,\n        element = context.element;\n\n    if (element.labelTarget || !canHaveRootElementReference(element)) {\n      return;\n    }\n\n    var businessObject = getBusinessObject(element),\n        rootElement = getRootElement(businessObject);\n\n    if (rootElement) {\n      // TODO(nikku): clone on copy\n      descriptor.referencedRootElement = rootElement;\n    }\n  });\n  eventBus.on('copyPaste.pasteElement', LOW_PRIORITY, function (context) {\n    var descriptor = context.descriptor,\n        businessObject = descriptor.businessObject,\n        referencedRootElement = descriptor.referencedRootElement;\n\n    if (!referencedRootElement) {\n      return;\n    }\n\n    if (!hasRootElement(referencedRootElement)) {\n      referencedRootElement = moddleCopy.copyElement(referencedRootElement, bpmnFactory.create(referencedRootElement.$type));\n    }\n\n    setRootElement(businessObject, referencedRootElement);\n    delete descriptor.referencedRootElement;\n  });\n}\nRootElementReferenceBehavior.$inject = ['bpmnjs', 'eventBus', 'injector', 'moddleCopy', 'bpmnFactory'];\ninherits(RootElementReferenceBehavior, CommandInterceptor); // helpers //////////\n\nfunction hasAnyEventDefinition(element, types) {\n  if (!isArray(types)) {\n    types = [types];\n  }\n\n  return some(types, function (type) {\n    return hasEventDefinition(element, type);\n  });\n}","map":{"version":3,"names":["inherits","find","isArray","matchPattern","some","CommandInterceptor","add","collectionAdd","remove","collectionRemove","getBusinessObject","is","isAny","hasEventDefinition","LOW_PRIORITY","RootElementReferenceBehavior","bpmnjs","eventBus","injector","moddleCopy","bpmnFactory","invoke","canHaveRootElementReference","element","hasAnyEventDefinition","hasRootElement","rootElement","definitions","getDefinitions","rootElements","get","id","getRootElementReferencePropertyName","eventDefinition","getRootElement","businessObject","eventDefinitions","setRootElement","set","executed","context","shape","addedRootElement","reverted","on","descriptor","labelTarget","referencedRootElement","copyElement","create","$type","$inject","types","type"],"sources":["E:/Old_PC/Study/Angular/test-bpm/node_modules/bpmn-js/lib/features/modeling/behavior/RootElementReferenceBehavior.js"],"sourcesContent":["import inherits from 'inherits-browser';\r\n\r\nimport {\r\n  find,\r\n  isArray,\r\n  matchPattern,\r\n  some\r\n} from 'min-dash';\r\n\r\nimport CommandInterceptor from 'diagram-js/lib/command/CommandInterceptor';\r\n\r\nimport {\r\n  add as collectionAdd,\r\n  remove as collectionRemove\r\n} from 'diagram-js/lib/util/Collections';\r\n\r\nimport {\r\n  getBusinessObject,\r\n  is\r\n} from '../../../util/ModelUtil';\r\n\r\nimport { isAny } from '../util/ModelingUtil';\r\n\r\nimport { hasEventDefinition } from '../../../util/DiUtil';\r\n\r\nvar LOW_PRIORITY = 500;\r\n\r\n\r\n/**\r\n * Add referenced root elements (error, escalation, message, signal) if they don't exist.\r\n * Copy referenced root elements on copy & paste.\r\n */\r\nexport default function RootElementReferenceBehavior(\r\n    bpmnjs, eventBus, injector, moddleCopy, bpmnFactory\r\n) {\r\n  injector.invoke(CommandInterceptor, this);\r\n\r\n  function canHaveRootElementReference(element) {\r\n    return isAny(element, [ 'bpmn:ReceiveTask', 'bpmn:SendTask' ]) ||\r\n      hasAnyEventDefinition(element, [\r\n        'bpmn:ErrorEventDefinition',\r\n        'bpmn:EscalationEventDefinition',\r\n        'bpmn:MessageEventDefinition',\r\n        'bpmn:SignalEventDefinition'\r\n      ]);\r\n  }\r\n\r\n  function hasRootElement(rootElement) {\r\n    var definitions = bpmnjs.getDefinitions(),\r\n        rootElements = definitions.get('rootElements');\r\n\r\n    return !!find(rootElements, matchPattern({ id: rootElement.id }));\r\n  }\r\n\r\n  function getRootElementReferencePropertyName(eventDefinition) {\r\n    if (is(eventDefinition, 'bpmn:ErrorEventDefinition')) {\r\n      return 'errorRef';\r\n    } else if (is(eventDefinition, 'bpmn:EscalationEventDefinition')) {\r\n      return 'escalationRef';\r\n    } else if (is(eventDefinition, 'bpmn:MessageEventDefinition')) {\r\n      return 'messageRef';\r\n    } else if (is(eventDefinition, 'bpmn:SignalEventDefinition')) {\r\n      return 'signalRef';\r\n    }\r\n  }\r\n\r\n  function getRootElement(businessObject) {\r\n    if (isAny(businessObject, [ 'bpmn:ReceiveTask', 'bpmn:SendTask' ])) {\r\n      return businessObject.get('messageRef');\r\n    }\r\n\r\n    var eventDefinitions = businessObject.get('eventDefinitions'),\r\n        eventDefinition = eventDefinitions[ 0 ];\r\n\r\n    return eventDefinition.get(getRootElementReferencePropertyName(eventDefinition));\r\n  }\r\n\r\n  function setRootElement(businessObject, rootElement) {\r\n    if (isAny(businessObject, [ 'bpmn:ReceiveTask', 'bpmn:SendTask' ])) {\r\n      return businessObject.set('messageRef', rootElement);\r\n    }\r\n\r\n    var eventDefinitions = businessObject.get('eventDefinitions'),\r\n        eventDefinition = eventDefinitions[ 0 ];\r\n\r\n    return eventDefinition.set(getRootElementReferencePropertyName(eventDefinition), rootElement);\r\n  }\r\n\r\n  // create shape\r\n  this.executed('shape.create', function(context) {\r\n    var shape = context.shape;\r\n\r\n    if (!canHaveRootElementReference(shape)) {\r\n      return;\r\n    }\r\n\r\n    var businessObject = getBusinessObject(shape),\r\n        rootElement = getRootElement(businessObject),\r\n        rootElements;\r\n\r\n    if (rootElement && !hasRootElement(rootElement)) {\r\n      rootElements = bpmnjs.getDefinitions().get('rootElements');\r\n\r\n      // add root element\r\n      collectionAdd(rootElements, rootElement);\r\n\r\n      context.addedRootElement = rootElement;\r\n    }\r\n  }, true);\r\n\r\n  this.reverted('shape.create', function(context) {\r\n    var addedRootElement = context.addedRootElement;\r\n\r\n    if (!addedRootElement) {\r\n      return;\r\n    }\r\n\r\n    var rootElements = bpmnjs.getDefinitions().get('rootElements');\r\n\r\n    // remove root element\r\n    collectionRemove(rootElements, addedRootElement);\r\n  }, true);\r\n\r\n  eventBus.on('copyPaste.copyElement', function(context) {\r\n    var descriptor = context.descriptor,\r\n        element = context.element;\r\n\r\n    if (element.labelTarget || !canHaveRootElementReference(element)) {\r\n      return;\r\n    }\r\n\r\n    var businessObject = getBusinessObject(element),\r\n        rootElement = getRootElement(businessObject);\r\n\r\n    if (rootElement) {\r\n\r\n      // TODO(nikku): clone on copy\r\n      descriptor.referencedRootElement = rootElement;\r\n    }\r\n  });\r\n\r\n  eventBus.on('copyPaste.pasteElement', LOW_PRIORITY, function(context) {\r\n    var descriptor = context.descriptor,\r\n        businessObject = descriptor.businessObject,\r\n        referencedRootElement = descriptor.referencedRootElement;\r\n\r\n    if (!referencedRootElement) {\r\n      return;\r\n    }\r\n\r\n    if (!hasRootElement(referencedRootElement)) {\r\n      referencedRootElement = moddleCopy.copyElement(\r\n        referencedRootElement,\r\n        bpmnFactory.create(referencedRootElement.$type)\r\n      );\r\n    }\r\n\r\n    setRootElement(businessObject, referencedRootElement);\r\n\r\n    delete descriptor.referencedRootElement;\r\n  });\r\n}\r\n\r\nRootElementReferenceBehavior.$inject = [\r\n  'bpmnjs',\r\n  'eventBus',\r\n  'injector',\r\n  'moddleCopy',\r\n  'bpmnFactory'\r\n];\r\n\r\ninherits(RootElementReferenceBehavior, CommandInterceptor);\r\n\r\n// helpers //////////\r\n\r\nfunction hasAnyEventDefinition(element, types) {\r\n  if (!isArray(types)) {\r\n    types = [ types ];\r\n  }\r\n\r\n  return some(types, function(type) {\r\n    return hasEventDefinition(element, type);\r\n  });\r\n}"],"mappings":"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"},"metadata":{},"sourceType":"module"}