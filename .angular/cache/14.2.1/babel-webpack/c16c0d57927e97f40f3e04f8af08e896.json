{"ast":null,"code":"import { collectLanes, getLanesRoot } from '../util/LaneUtil';\nimport { is } from '../../../util/ModelUtil';\nimport { add as collectionAdd, remove as collectionRemove } from 'diagram-js/lib/util/Collections';\nimport { asTRBL } from 'diagram-js/lib/layout/LayoutUtil';\nvar FLOW_NODE_REFS_ATTR = 'flowNodeRef',\n    LANES_ATTR = 'lanes';\n/**\n * A handler that updates lane refs on changed elements\n */\n\nexport default function UpdateFlowNodeRefsHandler(elementRegistry) {\n  this._elementRegistry = elementRegistry;\n}\nUpdateFlowNodeRefsHandler.$inject = ['elementRegistry'];\n\nUpdateFlowNodeRefsHandler.prototype.computeUpdates = function (flowNodeShapes, laneShapes) {\n  var handledNodes = [];\n  var updates = [];\n  var participantCache = {};\n  var allFlowNodeShapes = [];\n\n  function isInLaneShape(element, laneShape) {\n    var laneTrbl = asTRBL(laneShape);\n    var elementMid = {\n      x: element.x + element.width / 2,\n      y: element.y + element.height / 2\n    };\n    return elementMid.x > laneTrbl.left && elementMid.x < laneTrbl.right && elementMid.y > laneTrbl.top && elementMid.y < laneTrbl.bottom;\n  }\n\n  function addFlowNodeShape(flowNodeShape) {\n    if (handledNodes.indexOf(flowNodeShape) === -1) {\n      allFlowNodeShapes.push(flowNodeShape);\n      handledNodes.push(flowNodeShape);\n    }\n  }\n\n  function getAllLaneShapes(flowNodeShape) {\n    var root = getLanesRoot(flowNodeShape);\n\n    if (!participantCache[root.id]) {\n      participantCache[root.id] = collectLanes(root);\n    }\n\n    return participantCache[root.id];\n  }\n\n  function getNewLanes(flowNodeShape) {\n    if (!flowNodeShape.parent) {\n      return [];\n    }\n\n    var allLaneShapes = getAllLaneShapes(flowNodeShape);\n    return allLaneShapes.filter(function (l) {\n      return isInLaneShape(flowNodeShape, l);\n    }).map(function (shape) {\n      return shape.businessObject;\n    });\n  }\n\n  laneShapes.forEach(function (laneShape) {\n    var root = getLanesRoot(laneShape);\n\n    if (!root || handledNodes.indexOf(root) !== -1) {\n      return;\n    }\n\n    var children = root.children.filter(function (c) {\n      return is(c, 'bpmn:FlowNode');\n    });\n    children.forEach(addFlowNodeShape);\n    handledNodes.push(root);\n  });\n  flowNodeShapes.forEach(addFlowNodeShape);\n  allFlowNodeShapes.forEach(function (flowNodeShape) {\n    var flowNode = flowNodeShape.businessObject;\n    var lanes = flowNode.get(LANES_ATTR),\n        remove = lanes.slice(),\n        add = getNewLanes(flowNodeShape);\n    updates.push({\n      flowNode: flowNode,\n      remove: remove,\n      add: add\n    });\n  });\n  laneShapes.forEach(function (laneShape) {\n    var lane = laneShape.businessObject; // lane got removed XX-)\n\n    if (!laneShape.parent) {\n      lane.get(FLOW_NODE_REFS_ATTR).forEach(function (flowNode) {\n        updates.push({\n          flowNode: flowNode,\n          remove: [lane],\n          add: []\n        });\n      });\n    }\n  });\n  return updates;\n};\n\nUpdateFlowNodeRefsHandler.prototype.execute = function (context) {\n  var updates = context.updates;\n\n  if (!updates) {\n    updates = context.updates = this.computeUpdates(context.flowNodeShapes, context.laneShapes);\n  }\n\n  updates.forEach(function (update) {\n    var flowNode = update.flowNode,\n        lanes = flowNode.get(LANES_ATTR); // unwire old\n\n    update.remove.forEach(function (oldLane) {\n      collectionRemove(lanes, oldLane);\n      collectionRemove(oldLane.get(FLOW_NODE_REFS_ATTR), flowNode);\n    }); // wire new\n\n    update.add.forEach(function (newLane) {\n      collectionAdd(lanes, newLane);\n      collectionAdd(newLane.get(FLOW_NODE_REFS_ATTR), flowNode);\n    });\n  }); // TODO(nikku): return changed elements\n  // return [ ... ];\n};\n\nUpdateFlowNodeRefsHandler.prototype.revert = function (context) {\n  var updates = context.updates;\n  updates.forEach(function (update) {\n    var flowNode = update.flowNode,\n        lanes = flowNode.get(LANES_ATTR); // unwire new\n\n    update.add.forEach(function (newLane) {\n      collectionRemove(lanes, newLane);\n      collectionRemove(newLane.get(FLOW_NODE_REFS_ATTR), flowNode);\n    }); // wire old\n\n    update.remove.forEach(function (oldLane) {\n      collectionAdd(lanes, oldLane);\n      collectionAdd(oldLane.get(FLOW_NODE_REFS_ATTR), flowNode);\n    });\n  }); // TODO(nikku): return changed elements\n  // return [ ... ];\n};","map":{"version":3,"names":["collectLanes","getLanesRoot","is","add","collectionAdd","remove","collectionRemove","asTRBL","FLOW_NODE_REFS_ATTR","LANES_ATTR","UpdateFlowNodeRefsHandler","elementRegistry","_elementRegistry","$inject","prototype","computeUpdates","flowNodeShapes","laneShapes","handledNodes","updates","participantCache","allFlowNodeShapes","isInLaneShape","element","laneShape","laneTrbl","elementMid","x","width","y","height","left","right","top","bottom","addFlowNodeShape","flowNodeShape","indexOf","push","getAllLaneShapes","root","id","getNewLanes","parent","allLaneShapes","filter","l","map","shape","businessObject","forEach","children","c","flowNode","lanes","get","slice","lane","execute","context","update","oldLane","newLane","revert"],"sources":["E:/Old_PC/Study/Angular/test-bpm/node_modules/bpmn-js/lib/features/modeling/cmd/UpdateFlowNodeRefsHandler.js"],"sourcesContent":["import {\n  collectLanes,\n  getLanesRoot\n} from '../util/LaneUtil';\n\nimport {\n  is\n} from '../../../util/ModelUtil';\n\nimport {\n  add as collectionAdd,\n  remove as collectionRemove\n} from 'diagram-js/lib/util/Collections';\n\nimport {\n  asTRBL\n} from 'diagram-js/lib/layout/LayoutUtil';\n\nvar FLOW_NODE_REFS_ATTR = 'flowNodeRef',\n    LANES_ATTR = 'lanes';\n\n\n/**\n * A handler that updates lane refs on changed elements\n */\nexport default function UpdateFlowNodeRefsHandler(elementRegistry) {\n  this._elementRegistry = elementRegistry;\n}\n\nUpdateFlowNodeRefsHandler.$inject = [\n  'elementRegistry'\n];\n\n\nUpdateFlowNodeRefsHandler.prototype.computeUpdates = function(flowNodeShapes, laneShapes) {\n\n  var handledNodes = [];\n\n  var updates = [];\n\n  var participantCache = {};\n\n  var allFlowNodeShapes = [];\n\n  function isInLaneShape(element, laneShape) {\n\n    var laneTrbl = asTRBL(laneShape);\n\n    var elementMid = {\n      x: element.x + element.width / 2,\n      y: element.y + element.height / 2\n    };\n\n    return elementMid.x > laneTrbl.left &&\n           elementMid.x < laneTrbl.right &&\n           elementMid.y > laneTrbl.top &&\n           elementMid.y < laneTrbl.bottom;\n  }\n\n  function addFlowNodeShape(flowNodeShape) {\n    if (handledNodes.indexOf(flowNodeShape) === -1) {\n      allFlowNodeShapes.push(flowNodeShape);\n      handledNodes.push(flowNodeShape);\n    }\n  }\n\n  function getAllLaneShapes(flowNodeShape) {\n\n    var root = getLanesRoot(flowNodeShape);\n\n    if (!participantCache[root.id]) {\n      participantCache[root.id] = collectLanes(root);\n    }\n\n    return participantCache[root.id];\n  }\n\n  function getNewLanes(flowNodeShape) {\n    if (!flowNodeShape.parent) {\n      return [];\n    }\n\n    var allLaneShapes = getAllLaneShapes(flowNodeShape);\n\n    return allLaneShapes.filter(function(l) {\n      return isInLaneShape(flowNodeShape, l);\n    }).map(function(shape) {\n      return shape.businessObject;\n    });\n  }\n\n  laneShapes.forEach(function(laneShape) {\n    var root = getLanesRoot(laneShape);\n\n    if (!root || handledNodes.indexOf(root) !== -1) {\n      return;\n    }\n\n    var children = root.children.filter(function(c) {\n      return is(c, 'bpmn:FlowNode');\n    });\n\n    children.forEach(addFlowNodeShape);\n\n    handledNodes.push(root);\n  });\n\n  flowNodeShapes.forEach(addFlowNodeShape);\n\n\n  allFlowNodeShapes.forEach(function(flowNodeShape) {\n\n    var flowNode = flowNodeShape.businessObject;\n\n    var lanes = flowNode.get(LANES_ATTR),\n        remove = lanes.slice(),\n        add = getNewLanes(flowNodeShape);\n\n    updates.push({ flowNode: flowNode, remove: remove, add: add });\n  });\n\n  laneShapes.forEach(function(laneShape) {\n\n    var lane = laneShape.businessObject;\n\n    // lane got removed XX-)\n    if (!laneShape.parent) {\n      lane.get(FLOW_NODE_REFS_ATTR).forEach(function(flowNode) {\n        updates.push({ flowNode: flowNode, remove: [ lane ], add: [] });\n      });\n    }\n  });\n\n  return updates;\n};\n\nUpdateFlowNodeRefsHandler.prototype.execute = function(context) {\n\n  var updates = context.updates;\n\n  if (!updates) {\n    updates = context.updates = this.computeUpdates(context.flowNodeShapes, context.laneShapes);\n  }\n\n\n  updates.forEach(function(update) {\n\n    var flowNode = update.flowNode,\n        lanes = flowNode.get(LANES_ATTR);\n\n    // unwire old\n    update.remove.forEach(function(oldLane) {\n      collectionRemove(lanes, oldLane);\n      collectionRemove(oldLane.get(FLOW_NODE_REFS_ATTR), flowNode);\n    });\n\n    // wire new\n    update.add.forEach(function(newLane) {\n      collectionAdd(lanes, newLane);\n      collectionAdd(newLane.get(FLOW_NODE_REFS_ATTR), flowNode);\n    });\n  });\n\n  // TODO(nikku): return changed elements\n  // return [ ... ];\n};\n\n\nUpdateFlowNodeRefsHandler.prototype.revert = function(context) {\n\n  var updates = context.updates;\n\n  updates.forEach(function(update) {\n\n    var flowNode = update.flowNode,\n        lanes = flowNode.get(LANES_ATTR);\n\n    // unwire new\n    update.add.forEach(function(newLane) {\n      collectionRemove(lanes, newLane);\n      collectionRemove(newLane.get(FLOW_NODE_REFS_ATTR), flowNode);\n    });\n\n    // wire old\n    update.remove.forEach(function(oldLane) {\n      collectionAdd(lanes, oldLane);\n      collectionAdd(oldLane.get(FLOW_NODE_REFS_ATTR), flowNode);\n    });\n  });\n\n  // TODO(nikku): return changed elements\n  // return [ ... ];\n};\n"],"mappings":"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"},"metadata":{},"sourceType":"module"}